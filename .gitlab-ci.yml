stages:
  - build
  - deploy

variables:
  APP_NAME: "siuushop"
  APP_VERSION: "${CI_COMMIT_SHORT_SHA}"
  DEPLOY_PATH: "/opt/${APP_NAME}"
build:
  stage: build
  variables:
    GIT_STRATEGY: clone
  script:
    - echo "Building the application"
    - mvn clean package -DskipTests -Dproject.version=${APP_VERSION}
  artifacts:
    paths:
      - target/${APP_NAME}-${APP_VERSION}.jar
    expire_in: 1 week
  tags:
    - siuu-shop-shell
  only:
    - main

deploy:
  stage: deploy
  variables:
    GIT_STRATEGY: none
  script:
    - echo "Deploying the application"
    - sudo systemctl stop $APP_NAME || true
    - sudo cp target/${APP_NAME}-${APP_VERSION}.jar ${DEPLOY_PATH}/app.jar
    - sudo systemctl start $APP_NAME
    - sudo systemctl status $APP_NAME
    - echo "Deployed the application"
  tags:
    - siuu-shop-shell
  only:
    - main